#!/usr/bin/env bash

if [[ -z $P4CLIENT ]]; then 
    eval "$(p4env -print)"
fi 

his_changelist=$1
if [[ -z $his_changelist ]]; then 
    echo "Missing cmdline arguments:"
    echo "    \$1 - changelist to checkout"
    exit 1
fi 

read -p "Local changelist (optional): " local_changelist 
if [[ -z $local_changelist ]]; then 
    read -p "New description (optional): " desc
    if [[ -z $desc ]]; then 
        desc="[patch] cherry-pick $his_changelist"
    fi 

    local_changelist=$(p4 change -i <<EOF | awk '{print $2}'
Change: new

Client: $P4CLIENT
User: $P4USER
Status: new

Description:
    $desc
EOF
    )
    if [[ $? != 0 || -z $local_changelist ]]; then
        echo "Failed to create changelist" 
        exit 1
    fi
else
    read -p "Revert all files in $local_changelist? [Y/n]: " choice_revert
    if [[ -z $choice_revert || $choice_revert == y ]]; then 
        p4 revert -c $local_changelist //... || exit 1
    fi 
fi 

p4 unshelve -s $his_changelist -c $local_changelist || exit 1
p4 resolve || true 
echo "Changes saved into $local_changelist"